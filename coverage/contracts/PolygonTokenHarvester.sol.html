<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/PolygonTokenHarvester.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> PolygonTokenHarvester.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/35</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/37</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: Apache-2.0
pragma solidity ^0.8.5;
&nbsp;
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
&nbsp;
import "./ISmartYieldProvider.sol";
import "./matic/IRootChainManager.sol";
import "./matic/IERC20ChildToken.sol";
&nbsp;
/// @title PolygonTokenHarvester
/// @author Alex T
/// @notice Assists with moving any given token from the child chain to the root chain. Made for Polygon
/// @dev It needs to be deployed at the same address on both chains. Uses CREATE2 on deploy to achieve that
contract PolygonTokenHarvester is OwnableUpgradeable {
    using SafeERC20 for IERC20;
&nbsp;
    bool private _onRootChain;
&nbsp;
    address public rootChainManager;
    mapping(address =&gt; uint256) public lastWithdraw;
    uint256 public withdrawCooldown;
&nbsp;
    /// @notice Logs a transfer of tokens to owner
    /// @dev Emitted when transferToOwner is called
    /// @param caller Address that called transferToOwner
    /// @param owner Address that the funds have been transferred to
    /// @param token Address of the transferred token
    /// @param amount The amount of tokens that were sent to the child chain
    event TransferToOwner(address indexed caller, address indexed owner, address indexed token, uint256 amount);
&nbsp;
    /// @notice Logs a withdrawal being made on the root chain
    /// @dev Emitted when withdrawOnRoot is called
    /// @param caller Address that called withdrawOnRoot
    event WithdrawOnRoot(address indexed caller);
&nbsp;
    /// @notice Logs withdrawal being made on the child chain
    /// @dev Emitted when withdrawOnChild is called
    /// @param caller Address that called withdrawOnChild
    /// @param token Address of the withdrawn token
    /// @param amount The amount of tokens that were withdrawn
    event WithdrawOnChild(address indexed caller, address indexed token, uint256 amount);
&nbsp;
    /// @notice PolygonTokenHarvester initializer
    /// @dev Needs to be called after deployment. Get addresses from https://github.com/maticnetwork/static/tree/master/network
    /// @param _withdrawCooldown Number of blocks needed between withdrawals
    /// @param _rootChainManager Address of Polygon rootChainManager. Set to zero address on child chain
<span class="fstat-no" title="function not covered" >    function initialize(uint256 _withdrawCooldown, address _rootChainManager) public initializer {</span>
<span class="cstat-no" title="statement not covered" >        __Ownable_init()</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (_rootChainManager != address(0)) {</span>
<span class="cstat-no" title="statement not covered" >            _onRootChain = true</span>;
<span class="cstat-no" title="statement not covered" >            rootChainManager = _rootChainManager</span>;
        } else {
<span class="cstat-no" title="statement not covered" >            _onRootChain = false</span>;
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        withdrawCooldown = _withdrawCooldown</span>;
     }
&nbsp;
    /// @notice Allows the call only on the root chain
    /// @dev Checks is based on rootChainManager being set
<span class="fstat-no" title="function not covered" >    modifier onlyOnRoot {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            _onRootChain == true,
            "Harvester: should only be called on root chain"
        );
        _;
    }
&nbsp;
    /// @notice Allows the call only on the child chain
    /// @dev Checks is based on rootChainManager being not set
<span class="fstat-no" title="function not covered" >    modifier onlyOnChild {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            _onRootChain == false,
            "Harvester: should only be called on child chain"
        );
        _;
    }
&nbsp;
    /// @notice Sets the minimum number of blocks that must pass between withdrawals
    /// @dev This limit is set to not spam the withdrawal process with lots of small withdrawals
    /// @param _withdrawCooldown Number of blocks needed between withdrawals
<span class="fstat-no" title="function not covered" >    function setWithdrawCooldown(uint256 _withdrawCooldown) public onlyOwner onlyOnChild {</span>
<span class="cstat-no" title="statement not covered" >        withdrawCooldown = _withdrawCooldown</span>;
    }
&nbsp;
    // Root Chain Related Functions
&nbsp;
    /// @notice Withdraws to itself exited funds from Polygon
    /// @dev Forwards the exit call to the Polygon rootChainManager
    /// @param _data Exit payload created with the Matic SDK
    /// @return Bytes return of the rootChainManager exit call
<span class="fstat-no" title="function not covered" >    function withdrawOnRoot(bytes memory _data) public onlyOnRoot returns (bytes memory) {</span>
<span class="cstat-no" title="statement not covered" >        (bool success, bytes memory returnData) = rootChainManager.call(_data);</span>
<span class="cstat-no" title="statement not covered" >        require(success, string(returnData))</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit WithdrawOnRoot(_msgSender());</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        return returnData;</span>
    }
&nbsp;
    /// @notice Transfers full balance of token to owner
    /// @dev Use this after withdrawOnRoot to transfer what you have exited from Polygon to owner
    /// @param _token Address of token to transfer
<span class="fstat-no" title="function not covered" >    function transferToOwner(address _token) public onlyOnRoot {</span>
<span class="cstat-no" title="statement not covered" >        require(_token != address(0), "Harvester: token address must be specified")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        IERC20 erc20 = IERC20(_token);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        address to = owner();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 amount = erc20.balanceOf(address(this));</span>
<span class="cstat-no" title="statement not covered" >        erc20.safeTransfer(to, amount)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit TransferToOwner(_msgSender(), to, _token, amount);</span>
    }
&nbsp;
    /// @notice Exit funds from polygon and transfer to owner
    /// @dev Calls withdrawOnRoot then transferToOwner
    /// @param _data Exit payload created with the Matic SDK
    /// @param _token Address of token to transfer
<span class="fstat-no" title="function not covered" >    function withdrawAndTransferToOwner(bytes memory _data, address _token) public onlyOnRoot returns (bytes memory) {</span>
<span class="cstat-no" title="statement not covered" >        bytes memory returnData =  withdrawOnRoot(_data);</span>
<span class="cstat-no" title="statement not covered" >        transferToOwner(_token)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        return returnData;</span>
    }
&nbsp;
    // Child Chain Related Functions
&nbsp;
    /// @notice Withdraws full token balance from the child chain
    /// @dev Emits WithdrawOnChild on succesful withdraw and burn
    /// @param _childToken Address of token to withdraw
<span class="fstat-no" title="function not covered" >    function withdrawOnChild(address _childToken) public onlyOnChild {</span>
<span class="cstat-no" title="statement not covered" >        require(_childToken != address(0), "Harvester: child token address must be specified")</span>;
&nbsp;
        // if cooldown has not passed, we just skip it
<span class="cstat-no" title="statement not covered" >        if (block.number &lt; lastWithdraw[_childToken] + withdrawCooldown) {</span>
<span class="cstat-no" title="statement not covered" >            return;</span>
        }
<span class="cstat-no" title="statement not covered" >        lastWithdraw[_childToken] = block.number</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        IERC20ChildToken erc20 = IERC20ChildToken(_childToken);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 amount = erc20.balanceOf(address(this));</span>
<span class="cstat-no" title="statement not covered" >        erc20.withdraw(amount)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit WithdrawOnChild(_msgSender(), _childToken, amount);</span>
    }
&nbsp;
    /// @notice Transfer fees from SmartYield and withdraw them from the child chain
    /// @dev Helper that transfer fees from a SmartYield deployment as underlaying token.
    /// @param _syProvider SmartYield deployment address
<span class="fstat-no" title="function not covered" >    function claimAndWithdrawOnChild(address _syProvider) public onlyOnChild {</span>
<span class="cstat-no" title="statement not covered" >        require(_syProvider != address(0), "Harvester: sy provider address must not be 0x0")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        ISmartYieldProvider provider = ISmartYieldProvider(_syProvider);</span>
<span class="cstat-no" title="statement not covered" >        address underlying = provider.uToken();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        provider.transferFees()</span>;
<span class="cstat-no" title="statement not covered" >        withdrawOnChild(underlying)</span>;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Jul 02 2021 12:48:17 GMT+0300 (Eastern European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
